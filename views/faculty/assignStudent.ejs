<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Student</title>
    <link rel="stylesheet" href="/css/iziToast.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/spinner.css">
    <link rel="stylesheet" href="/css/cards.css">
    <link rel="shortcut icon" href="//www.ibm.com/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="stylesheet" href="/css/dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"
        integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw=="
        crossorigin="anonymous" />

</head>


<body>
    <%-include('../partials/config')%>


    <div class="app-container app-theme-white body-tabs-shadow fixed-sidebar fixed-header">
        <!-- header/ navbar area -->
        <%-include('../partials/header.ejs')%>
        <!-- header/navbar area end -->

        <div class="app-main">
            <!-- side bar area -->
            <%-include('../partials/sidebar.ejs')%>
            <!-- sidebar area end -->
            <div class="app-main__outer">
                <div class="app-main__inner">
                    <!-- <div class="app-page-title">
                        <div class="page-title-wrapper">
                            <div class="page-title-heading">
                                <div class="page-title-icon">
                                    <i class="fas fa-home icon-gradient bg-mean-fruit">
                                    </i>
                                </div>
                                <div>Welcome to IBM ICE Learning Management System
                                    <div class="page-title-subheading">
                                        <div class="d-flex justify-content-center ">
                                            This is a learning management system which will help you get a headstart at
                                            latest technologies, and keep track of your
                                            progress while you learn and grow.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> -->
                    <div class="mb-3">
                        <div class="card-header card-header-tab-animation">
                            <ul class="nav nav-justified">
                                <li class="nav-item"><a data-toggle="tab" href="#tab-eg115-0"
                                        class="nav-link active">Assign one by one</a></li>
                                <li class="nav-item"><a data-toggle="tab" href="#tab-eg115-1" class="nav-link">Multi
                                        Student Course assign</a>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content">
                                <div class="tab-pane active" id="tab-eg115-0" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-4 col-lg-4">
                                            <div class="card-hover-shadow-2x mb-3 card">
                                                <div class="card-header-tab card-header d-flex justify-content-between">
                                                    <div
                                                        class="card-header-title font-size-lg text-capitalize font-weight-normal">
                                                        <i class="header-icon fas fa-users">
                                                        </i>Students
                                                    </div>
                                                </div>
                                                <div class="scroll-area-lg">
                                                    <div class="scrollbar-container">
                                                        <div class="p-2">
                                                            <ul id="students"
                                                                class="todo-list-wrapper list-group list-group-flush">
                                                                <%  const colors = ["g", "alternate", "info", "success", "primary", "warning", "dark", "secondary", "light"]; %>
                                                                <% if(students.length === 0){ %>
                                                                <div class="border col-12">
                                                                    <div class="card-body text-center">
                                                                        <!-- Image -->
                                                                        <img src="/assets/images/undraw_empty.svg"
                                                                            alt="..." class="img-fluid"
                                                                            style="max-width: 182px;">

                                                                        <!-- Title -->
                                                                        <h3>
                                                                            No Students available
                                                                        </h3>
                                                                        <!-- Subtitle -->
                                                                        <p class="text-muted">
                                                                            ask spoc to add some &nbsp;<a
                                                                                style="text-decoration: none;"
                                                                                href="#"><b
                                                                                    class="text-primary">Student</b></a>
                                                                            based
                                                                            on
                                                                            your specialization track.
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <% } else { students.forEach(student => {%>
                                                                <li id="<%=student.id%>"
                                                                    class="list-group-item mb-3 result"
                                                                    data-spec="${student.specialization}"
                                                                    data-student="<%=student.id%>"
                                                                    style="border: 0; cursor: pointer;"
                                                                    onclick="getUserCourses('<%=student.id%>')">
                                                                    <div class="widget-content p-0">
                                                                        <div class="widget-content-wrapper">
                                                                            <div class="widget-content-left">
                                                                                <a class="widget-heading"
                                                                                    id="mainnames">
                                                                                    <%=student.firstName%>
                                                                                    <%=student.lastName%>
                                                                                </a>
                                                                                <span
                                                                                    class="badge badge-sm p-1 badge-<%= colors[student.semester]%>">
                                                                                    Semester
                                                                                    <%=student.semester%></span>
                                                                            </div>

                                                                            <div class="widget-content-right">
                                                                                <span
                                                                                    style="overflow: hidden;text-overflow: ellipsis;"
                                                                                    class="badge badge-${colors[student.specializationId]} badge-sm p-1">
                                                                                    <%=student.specializationName%>
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </li>
                                                                <%})}%>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-footer">
                                                    <div class="search-wrapper">
                                                        <div class="input-holder">
                                                            <input onkeyup="myFunction()" type="text"
                                                                class="search-input" id="namess"
                                                                placeholder="Type name to search student">
                                                            <button class="search-icon"><span></span></button>
                                                        </div>
                                                        <button class="close"></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-8 col-lg-8">
                                            <div class="card-hover-shadow-2x mb-3 card">
                                                <div class="card-header-tab card-header d-flex justify-content-between">
                                                    <div
                                                        class="card-header-title font-size-lg text-capitalize font-weight-normal">
                                                        <i class="header-icon fas fa-cart-plus">
                                                        </i>Course List
                                                    </div>
                                                </div>
                                                <div class="scroll-area-lg">
                                                    <div class="scrollbar-container" style="overflow-y: scroll;">

                                                        <div class="p-2">
                                                            <div style="display: flex; flex-direction: row;">
                                                                <div style="flex: 1; border-right: 3px solid gray;">
                                                                    <div class="card-header">
                                                                        <h5 style="font-size: 0.8rem;"
                                                                            class="card-heading">
                                                                            Assigned Courses
                                                                        </h5>
                                                                    </div>
                                                                    <div id="loader2" style="display: none;">
                                                                        <img style="width: 100%; height: 18rem;"
                                                                            src="/assets/images/loading.gif" alt="">
                                                                    </div>
                                                                    <ul class="todo-list-wrapper list-group list-group-flush "
                                                                        id="assignedCourses">
                                                                    </ul>
                                                                </div>
                                                                <div style="flex: 1.2;">
                                                                    <div class="card-header">
                                                                        <h5 style="font-size: 0.8rem;"
                                                                            class="card-heading">
                                                                            Available Courses
                                                                        </h5>
                                                                    </div>
                                                                    <div id="loader3" style="display: none;">
                                                                        <img style="width: 100%; height: 18rem;"
                                                                            src="/assets/images/loading.gif" alt="">
                                                                    </div>
                                                                    <ul class="todo-list-wrapper list-group list-group-flush"
                                                                        id="courses">

                                                                    </ul>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="d-block text-right card-footer">
                                                    <button onclick="openDialog()" id="assignSelected" style="text-decoration: none
                                                                                        ;" class="btn btn-link">Assign
                                                        &nbsp; <i class="fas fa-check"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane" id="tab-eg115-1" role="tabpanel">
                                    <div class="card-hover-shadow-2x mb-3 card">
                                        <div class="card-header d-flex justify-content-between">
                                            <div
                                                class="card-header-title font-size-lg text-capitalize font-weight-normal">
                                                <i class="header-icon fas fa-cart-plus">
                                                </i>Course List
                                            </div>
                                            <div class="form-group col-7 mt-1">
                                                <select class="form-control" id="coursem">
                                                    <option selected disabled>Please select course to assign</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div id="loaderstd" class="border container-fluid"
                                                style="width: 100%; display: none">
                                                <div class="card-body text-center">
                                                    <img src="/assets/images/undraw_empty.svg" alt="..."
                                                        class="img-fluid" style="max-width: 182px;">
                                                    <h3>
                                                        No Students available
                                                    </h3>
                                                    <p class="text-muted">
                                                        ask spoc to add some &nbsp;<a style="text-decoration: none;"
                                                            href="#"><b class="text-primary">Student</b></a>
                                                        based
                                                        on
                                                        your specialization track.
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table id="studenttable" class="table table-borderless">
                                                    <thead>
                                                        <tr>
                                                            <th>
                                                                <div class="custom-checkbox custom-control">
                                                                    <input type="checkbox" id="sid-"
                                                                        class="custom-control-input ckbCheckAll">
                                                                    <label class="custom-control-label"
                                                                        for="sid-"></label>
                                                                </div>
                                                            </th>
                                                            <th>Name</th>
                                                            <th>Specialization</th>
                                                            <th>Semester</th>
                                                            <th>assigned Details</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="std">

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="d-block text-right card-footer">
                                            <button id="assignm" style="text-decoration: none;"
                                                class="btn btn-link">Assign
                                                &nbsp; <i class="fas fa-check"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="/js/main.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/iziToast.min.js"></script>
    <script src="/js/flashMessage.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.7.0/moment.min.js" type="text/javascript"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"
        integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A=="
        crossorigin="anonymous"></script>
    <!-- <script>
        $('#studenttable').dataTable();
    </script> -->

    <script>
        var user;
        function getUserCourses(id) {
            user = id;
            fetch('/faculty/assignStudent/' + id).then(res => res.json()).then(json => {
                $("#loader2").show();
                $("#loader3").show();
                $("#students li").each(function (n) {
                    $(this).css("border-left", "0px");
                    $(this).removeClass('shadow-lg')
                });

                $(`#${id}`).css("border-left", "3px solid blue")
                $(`#${id}`).addClass("shadow-lg")
                if (json.status == 200) {
                    $("#loader2").hide();
                    $("#loader3").hide();
                    $('#courses').empty()
                    $('#assignedCourses').empty()
                    if (json.assignedCourses.length === 0) {
                        $('#assignedCourses').append(` 
                            <br>
                            <br>
                                    <div class="container-fluid">
                                        <article>
                                            <div class="d-flex flex-row justify-content-center">
                                                <img style="width: 200px;" src="../../assets/images/undraw_empty.svg"
                                                    alt="">
                                            </div>
                                            <br>
                                            <div class="d-flex justify-content-center">
                                                <h6 class="">No Course assigned to this student</h6>
                                            </div>
                                        </article>
                                    </div>`)
                    }
                    else {
                        json.assignedCourses.forEach(course => {
                            $('#assignedCourses').append(`
                                <li id="${course.id}" class="list-group-item mb-3"
                                    style="border: 0; cursor: pointer;">
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                            <div class="widget-content-left">
                                                <div class="widget-heading">
                                                    ${course.name}
                                                </div>
                                            <span class="badge badge-danger badge-sm p-1">${ moment(course.expiresAt)}</span>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </li>
                                
                            `)
                        })
                    }

                    if (json.availableCourses.length === 0) {
                        $('#courses').append(` 
                            <br>
                            <br>
                                    <div class="container-fluid">
                                        <article>
                                            <div class="d-flex flex-row justify-content-center">
                                                <img style="width: 200px;" src="../../assets/images/undraw_empty.svg"
                                                    alt="">
                                            </div>
                                            <br>
                                            <div class="d-flex justify-content-center">
                                                <h6 class="">No Course available to assign</h6>
                                            </div>
                                        </article>
                                    </div>`)
                    }
                    else {
                        json.availableCourses.forEach(course => {
                            $('#courses').append(`
                                <li id="${course.id}" class="list-group-item mb-3"
                                    style="border: 0; cursor: pointer;">
                                    
                                    <div class="widget-content p-0">
                                        <div class="widget-content-wrapper">
                                        <div class="widget-content-left mr-2">
                                            <div class="custom-checkbox custom-control">
                                                <input type="radio" name="courseIds" value="${course.id}" />
                                            </div>
                                        </div>
                                        <div class="widget-content-left mr-3">
                                            <div class="widget-content-left">
                                                <div class="widget-heading">
                                                    ${course.name}
                                                </div>
                                                <div class="widget-subheading">Semester ${course.semester}</div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            `)
                        })
                    }
                } else {


                    iziToast.error({
                        title: 'Error',
                        message: json.message || 'Something Went Wrong!',
                        position: 'topRight',
                        timeout: 10000
                    })
                }
            }).catch(err => console.log(err))
        }

        function assignCourse(userId, academicCourseId, expiresAt) {
            fetch('/faculty/assignStudent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId, academicCourseId, expiresAt })
            }).then(res => res.json())
                .then(json => {
                    if (json.status === 201) {
                        getUserCourses(user)
                        iziToast.success({
                            title: 'Success',
                            message: json.message,
                            position: 'topRight',
                            timeout: 5000
                        })
                    } else {
                        getUserCourses(user)
                        iziToast.error({
                            title: 'Error',
                            message: json.message || 'Something Went Wrong!',
                            position: 'topRight',
                            timeout: 10000
                        })
                    }
                })
                .catch(console.log)
        }

        const openDialog = () => {
            var exDate;
            let courseId = $('input[name="courseIds"]:checked').val();
            if (courseId === undefined) {
                iziToast.error({
                    title: 'Error',
                    message: 'Please select student and course to procced further',
                    position: 'center',
                    timeout: 10000
                })

            }
            else {
                iziToast.info({
                    timeout: 20000,
                    overlay: true,
                    displayMode: 'once',
                    id: 'inputs',
                    zindex: 999,
                    title: 'Select course expiration date',
                    position: 'center',
                    drag: false,
                    inputs: [
                        ['<input type="datetime-local">', 'change', function (instance, toast, input, e) {
                            exDate = input.value;
                        }]
                    ],
                    buttons: [
                        ['<button><b>YES</b></button>', function (instance, toast) {

                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                            iziToast.question({
                                timeout: 20000,
                                close: false,
                                overlay: true,
                                displayMode: 'once',
                                id: 'question',
                                zindex: 999,
                                title: 'Hey',
                                message: 'Are you sure about that?',
                                position: 'center',
                                buttons: [
                                    ['<button><b>YES</b></button>', function (instance, toast) {

                                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                                        assignCourse(user, courseId, exDate)

                                    }, true],
                                    ['<button>NO</button>', function (instance, toast) {

                                        instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                                    }],
                                ],

                                onClosing: function (instance, toast, closedBy) {
                                    console.info('Closing | closedBy: ' + closedBy);
                                },
                                onClosed: function (instance, toast, closedBy) {
                                    console.info('Closed | closedBy: ' + closedBy);
                                }
                            });

                        }, true]],

                });
            }
        }

        $(".ckbCheckAll").click(function () {
            $(".checkBoxClass").prop('checked', $(this).prop('checked'));
        });

        $(document).ready(function () {
            let studentSelect = $("#coursem").select2({
                width: '100%',
            })
            fetch('/faculty/assignStudent/api/courses').then(res => res.json())
                .then(json => {
                    if (json.courses.length) {
                        json.courses.forEach(a => {
                            // create the option and append to Select2
                            var option = new Option(a.name, a.id, false, false);
                            studentSelect.append(option)
                        })
                    }
                })
                .catch(err => console.log(err))
        });

        $("#coursem").change(function () {
            $("input:checkbox").prop('checked', false);
            $('#studenttable').DataTable().destroy();
            $('#std').empty()
            $('#loaderstd').hide()
            if ($(this).val()) {
                fetch(`/faculty/assignStudent/api/${$(this).val()}/students`).then(res => res.json())
                    .then(json => {
                        if (json.students.length) {
                            $('#loaderstd').hide()
                            let listItems = '';
                            json.students.forEach(a => {
                                if (a.isAssigned) {
                                    listItems += `<tr>
                                        <td>
                                            
                                        </td>
                                        <td>
                                            <h6>${a.firstName + ' ' + a.lastName}</h6>
                                        </td>
                                        <td><span
                                                class="badge badge-pill badge-light">${json.specialization.name}</span>
                                        </td>
                                        <td><span
                                                class="badge badge-sm p-1 badge-dark">
                                                Semester
                                                ${a.semester}</span></td>
                                        <td>
                                            <span class="mb-1 badge badge-info">${
                                        new Date(a.assignedAt).toLocaleDateString('en-GB', {
                                            year: '2-digit',
                                            month: 'short',
                                            day: 'numeric'
                                        })
                                        }</span>
                                        to
                                            <span class="badge badge-danger">${
                                        new Date(a.expiresAt).toLocaleDateString('en-GB', {
                                            year: '2-digit',
                                            month: 'short',
                                            day: 'numeric'
                                        })
                                        }</span>
                                        </td>
                                    </tr>`
                                }
                                else {
                                    listItems
                                        += `
                                <tr>
                                        <td>
                                            <div class="custom-checkbox custom-control">
                                                <input name="mstd" value="${a.id}" type="checkbox" id="sid-${a.id}"
                                                    class="custom-control-input checkBoxClass">
                                                <label class="custom-control-label"
                                                    for="sid-${a.id}"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <h6>${a.firstName + ' ' + a.lastName}</h6>
                                        </td>
                                        <td><span
                                                class="badge badge-pill badge-light">${json.specialization.name}</span>
                                        </td>
                                        <td><span
                                                class="badge badge-sm p-1 badge-dark">
                                                Semester
                                                ${a.semester}</span></td>
                                        <td>
                                            N-A
                                        </td>
                                    </tr>`
                                }
                            })
                            $('#std').append(listItems);

                            $('#studenttable').dataTable({
                                searching: true,
                                paging: true,
                                pageLength: 50,
                                info: false,
                                scrollCollapse: true,
                                scrollY: '60vh',
                                "aLengthMenu": [[10, 25, 50, 75, -1], [10, 25, 50, 75, "All"]],
                                "iDisplayLength": 10
                            });
                        }
                        else {
                            $('#studenttable').DataTable().destroy();
                            $('#loaderstd').show()

                        }
                    })
                    .catch(err => console.log(err))
            }
        });
        $('#assignm').on('click', function () {
            var expiresAt;
            let students = [];
            if ($("#coursem").val()) {
                $("input:checkbox[name='mstd']:checked").each(function () {
                    students.push($(this).val());
                });
                console.log(students)
                // students.shift()
                if (students.length) {
                    iziToast.info({
                        timeout: 20000,
                        overlay: true,
                        displayMode: 'once',
                        id: 'inputs',
                        zindex: 999,
                        title: 'Select course expiration date',
                        position: 'center',
                        drag: false,
                        inputs: [
                            ['<input type="datetime-local">', 'change', function (instance, toast, input, e) {
                                expiresAt = input.value;
                            }]
                        ],
                        buttons: [
                            ['<button><b>YES</b></button>', function (instance, toast) {

                                instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');
                                iziToast.question({
                                    timeout: 20000,
                                    close: false,
                                    overlay: true,
                                    displayMode: 'once',
                                    id: 'question',
                                    zindex: 999,
                                    title: 'Hey',
                                    message: 'Are you sure about that?',
                                    position: 'center',
                                    buttons: [
                                        ['<button><b>YES</b></button>', function (instance, toast) {

                                            fetch('/faculty/assignStudent/api/assignCourse', {
                                                method: 'POST',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                },
                                                body: JSON.stringify({
                                                    courseId: $("#coursem").val(),
                                                    expiresAt,
                                                    students
                                                })
                                            }).then(res => res.json())
                                                .then(json => {
                                                    console.log(json)
                                                    if (json.status === 200) {
                                                        iziToast.success({
                                                            title: 'Success',
                                                            message: json.message,
                                                            position: 'topRight',
                                                            timeout: 5000
                                                        })
                                                    } else {
                                                        iziToast.error({
                                                            title: 'Error',
                                                            message: json.message || 'Something Went Wrong!',
                                                            position: 'topRight',
                                                            timeout: 10000
                                                        })
                                                    }
                                                })
                                                .catch(err => console.log(err))
                                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                                        }, true],
                                        ['<button>NO</button>', function (instance, toast) {

                                            instance.hide({ transitionOut: 'fadeOut' }, toast, 'button');

                                        }],
                                    ],

                                    onClosing: function (instance, toast, closedBy) {
                                        console.info('Closing | closedBy: ' + closedBy);
                                    },
                                    onClosed: function (instance, toast, closedBy) {
                                        console.info('Closed | closedBy: ' + closedBy);
                                    }
                                });

                            }, true]],

                    });

                }
            }
        })


    </script>
    <script>
        function myFunction() {
            // Declare variables
            var input, filter, ul, li, a, i, txtValue;
            filter = $('#namess').val().toUpperCase().replace(/\s+/g, '');
            ul = document.getElementById("students");
            li = ul.getElementsByTagName('li');

            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < li.length; i++) {
                a = li[i].getElementsByTagName("a")[0];
                txtValue = a.textContent || a.innerText;
                txtValue.replace(/\s+/g, '')
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }
    </script>
</body>

</html>